name: Unity Package Release

on:
  workflow_call:
    inputs:
      package-name:
        required: true
        type: string
        description: "The name of the package to be released"
      create-unity-package:
        required: false
        type: boolean
        default: true
        description: "Whether to create .unitypackage file"
      create-zip:
        required: false
        type: boolean
        default: true
        description: "Whether to create zip file"
      version-file:
        required: false
        type: string
        default: "package.json"
        description: "File to read version from"
      changelog-file:
        required: false
        type: string
        default: "CHANGELOG.md"
        description: "Path to changelog file"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取所有历史记录用于生成changelog

      - name: Get Version
        id: version
        run: |
          if [ ! -f "${{ inputs.version-file }}" ]; then
            echo "错误：找不到 ${{ inputs.version-file }} 文件"
            exit 1
          fi
          echo "version=$(jq -r .version ${{ inputs.version-file }})" >> $GITHUB_OUTPUT
          echo "找到版本号：$(jq -r .version ${{ inputs.version-file }})"
    
      - name: Set Environment Variables
        run: |
          echo "zipFile=${{ github.workspace }}/${{ inputs.package-name }}-${{ steps.version.outputs.version }}.zip" >> $GITHUB_ENV
          echo "unityPackage=${{ github.workspace }}/${{ inputs.package-name }}-${{ steps.version.outputs.version }}.unitypackage" >> $GITHUB_ENV

      - name: Create Package Zip
        if: inputs.create-zip
        run: |
          cd ${{ github.workspace }}
          zip -r "${{ env.zipFile }}" .
          if [ ! -f "${{ env.zipFile }}" ]; then
            echo "错误：zip文件创建失败"
            exit 1
          fi
      
      - name: Track Package Meta Files
        if: inputs.create-unity-package
        run: find . -name \*.meta >> metaList
      
      - name: Create UnityPackage
        if: inputs.create-unity-package
        uses: pCYSl5EDgo/create-unitypackage@v1.2.3
        with:
          package-path: ${{ env.unityPackage }}
          include-files: metaList

      - name: Get Changelog Entry
        id: changelog_reader
        continue-on-error: true
        uses: mindsers/changelog-reader-action@v2
        with:
          version: ${{ steps.version.outputs.version }}
          path: ${{ inputs.changelog-file }}

      - name: Set Default Changelog
        if: steps.changelog_reader.outcome == 'failure'
        id: default_changelog
        run: |
          echo "changes=Release version ${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT

      - name: Prepare Release Files
        id: prepare_files
        run: |
          files=()
          if [[ "${{ inputs.create-zip }}" == "true" ]]; then
            files+=("${{ env.zipFile }}")
          fi
          if [[ "${{ inputs.create-unity-package }}" == "true" ]]; then
            files+=("${{ env.unityPackage }}")
          fi
          # 确保使用正确的package.json路径
          if [[ -f "${{ github.workspace }}/${{ inputs.version-file }}" ]]; then
            files+=("${{ inputs.version-file }}")
          fi
          echo "准备发布的文件："
          printf '%s\n' "${files[@]}"
          echo "files=${files[*]}" >> $GITHUB_OUTPUT

      - name: Make Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.changelog_reader.outcome == 'success' && steps.changelog_reader.outputs.changes || steps.default_changelog.outputs.changes }}
          files: ${{ steps.prepare_files.outputs.files }}
          tag_name: ${{ steps.version.outputs.version }} 